<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MoQ Subscriber</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 15px;
      background-color: #f8f9fa;
    }

    .container {
      max-width: 100%;
    }

    h3 {
      margin: 0 0 10px 0;
      color: #2d3748;
      font-size: 16px;
    }

    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #e2e8f0;
      background: #f7fafc;
      font-size: 13px;
      font-weight: 500;
    }

    .status.connected {
      background: #c6f6d5;
      border-color: #9ae6b4;
      color: #22543d;
    }

    .status.error {
      background: #fed7d7;
      border-color: #fc8181;
      color: #742a2a;
    }

    .messages {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      padding: 10px;
      max-height: 150px;
      overflow-y: auto;
      margin: 10px 0;
    }

    .message {
      padding: 8px;
      margin: 5px 0;
      background: #edf2f7;
      border-radius: 4px;
      font-size: 13px;
    }

    .message .time {
      color: #718096;
      font-size: 11px;
      margin-right: 8px;
    }

    .log {
      background: #1a202c;
      color: #e2e8f0;
      padding: 10px;
      border-radius: 4px;
      max-height: 150px;
      overflow-y: auto;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 11px;
      margin-top: 10px;
    }

    .log-entry {
      margin: 3px 0;
      padding: 3px;
      border-left: 3px solid transparent;
      padding-left: 8px;
    }

    .log-entry.info { border-left-color: #4299e1; }
    .log-entry.success { border-left-color: #48bb78; }
    .log-entry.error { border-left-color: #f56565; }

    .log-entry .timestamp {
      color: #a0aec0;
      margin-right: 8px;
      font-size: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h3>ðŸ“¥ Subscriber</h3>
    <div id="status" class="status">Initializing...</div>

    <div class="messages" id="messages">
      <div style="color: #a0aec0; font-size: 12px; text-align: center;">Waiting for messages...</div>
    </div>

    <div class="log" id="log"></div>
  </div>

  <script type="module">
    import * as Moq from 'https://esm.sh/@moq/lite';

    // Get URL parameters
    const params = new URLSearchParams(window.location.search);
    const relayUrl = params.get('relay') || 'https://relay.quic.video:4443';
    const broadcastName = params.get('broadcast') || 'my-broadcast';

    // UI Elements
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const messagesEl = document.getElementById('messages');

    // State
    let connection = null;
    let messageCount = 0;

    // Logging
    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.innerHTML = `<span class="timestamp">[${timestamp}]</span>${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function updateStatus(message, type = 'info') {
      statusEl.textContent = message;
      statusEl.className = 'status';
      if (type === 'success') statusEl.className = 'status connected';
      if (type === 'error') statusEl.className = 'status error';
    }

    function displayMessage(text) {
      // Clear placeholder if this is first message
      if (messageCount === 0) {
        messagesEl.innerHTML = '';
      }

      messageCount++;
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message';
      const timestamp = new Date().toLocaleTimeString();
      messageDiv.innerHTML = `<span class="time">${timestamp}</span>${text}`;
      messagesEl.appendChild(messageDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }



    async function getCatalog(broadcast, catalogTrack) {
      try {
        


        catalogTrack = broadcast.subscribe('catalog.json')
        for (;;) {
          console.log("Catalog track", catalogTrack)
          const catalogGroup = await catalogTrack.nextGroup();

          console.log("Group", catalogGroup)

          if (catalogGroup) {
            const catalogJson = await catalogGroup.readString();
            const catalog = JSON.parse(catalogJson);
            log('Received catalog', 'success');
            console.log('Catalog:', catalog);
            return catalog;
          }
        }
      } catch (e) {
        await new Promise((r) => setTimeout(r, 500));
        return await getCatalog(broadcast, catalogTrack);
      }
    }

    async function getCatalogTrack(broadcast){

          const catalogTrack  = await broadcast.subscribe('catalog.json')

          console.log("Catalog track")
          console.log(await catalogTrack.state.closed);

          return catalogTrack;

          

    }




    async function init() {
      try {
        updateStatus('Connecting to relay...', 'info');
        connection = await Moq.Connection.connect(new URL(relayUrl));
        log('Connected to relay', 'success');

        const broadcast = connection.consume(broadcastName);
        log(`Consuming broadcast: ${broadcastName}`, 'info');

        log(`Listening for catelog`);

        const catalogTrack = await getCatalogTrack(broadcast);



        console.log("Subscribed", catalogTrack.state)
 
        const catalog = await getCatalog(broadcast, catalogTrack);

        updateStatus('Subscribing to tracks...', 'info');

        // Subscribe to video track
        const videoTrack = broadcast.subscribe('video');
        log('Subscribed to video track', 'success');
/*
        // Subscribe to audio track
        const audioTrack = broadcast.subscribe('audio');
        log('Subscribed to audio track', 'success');
*/
        updateStatus('Ready to receive data', 'success');

        // Listen for video data
        (async () => {
          try {
            while (true) {
              const group = await videoTrack.nextGroup();
              if (!group) break;
              const frame = await group.readFrame();

              // TODO: Process video data
            }
          } catch (error) {
            log('Video read error: ' + error.message, 'error');
          }
        })();
/*
        // Listen for audio data
        (async () => {
          try {
            while (true) {
              const group = await audioTrack.nextGroup();
              if (!group) break;


              const frame = await group.readFrame();

//              console.log("frame", frame)
        

              
              // TODO: Process audio data
            }
          } catch (error) {
            log('Audio read error: ' + error.message, 'error');
          }
        })();
*/
      } catch (error) {
        updateStatus('Connection failed', 'error');
        log('Init error: ' + error.message, 'error');
      }
    }

    // Initialize
    init();
  </script>
</body>
</html>
