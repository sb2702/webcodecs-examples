<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebCodecs Player</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .video-container {
      position: relative;
      width: 640px;
      margin: 0 auto;
      display: flex;
      justify-content: center;
    }

    canvas {
      display: block;
      background-color: #000;
      border-radius: 4px;
      margin: 0 auto;
    }
    
    .controls {
      width: 640px;
      margin: 10px auto;
      background-color: #f5f5f5;
      border-radius: 4px;
      padding: 10px;
    }
    
    .transport-controls {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .transport-controls button {
      background-color: #2d3748;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      margin-right: 10px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s;
    }
    
    .transport-controls button:hover {
      background-color: #4a5568;
    }
    
    .transport-controls button:disabled {
      background-color: #a0aec0;
      cursor: not-allowed;
    }
    
    .time-display {
      margin-left: auto;
      font-family: monospace;
      font-size: 14px;
      color: #4a5568;
    }
    
    .seek-container {
      width: 100%;
      display: flex;
      align-items: center;
    }
    
    .seek-bar {
      flex-grow: 1;
      height: 8px;
      -webkit-appearance: none;
      background-color: #cbd5e0;
      border-radius: 4px;
      outline: none;
      transition: background 0.2s;
    }
    
    .seek-bar::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: #3182ce;
      cursor: pointer;
    }
    
    .seek-bar::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: #3182ce;
      cursor: pointer;
      border: none;
    }
    
    .file-controls {
      margin-top: 20px;
      display: flex;
      justify-content: center;
    }
    
    .file-controls button {
      background-color: #3182ce;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s;
    }
    
    .file-controls button:hover {
      background-color: #2b6cb0;
    }
    
    .disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .debug-panel {
      width: 640px;
      margin: 20px auto;
      background-color: #1a202c;
      color: #e2e8f0;
      border-radius: 4px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }

    .debug-panel h3 {
      margin: 0 0 10px 0;
      color: #63b3ed;
      font-size: 14px;
    }

    .debug-section {
      margin-bottom: 15px;
      padding: 10px;
      background-color: #2d3748;
      border-radius: 3px;
    }

    .debug-section h4 {
      margin: 0 0 8px 0;
      color: #68d391;
      font-size: 13px;
    }

    .debug-row {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      border-bottom: 1px solid #4a5568;
    }

    .debug-row:last-child {
      border-bottom: none;
    }

    .debug-label {
      color: #a0aec0;
    }

    .debug-value {
      color: #f7fafc;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>WebCodecs Player</h1>
    
    <div class="video-container">
      <canvas id="canvas" width="640" height="360"></canvas>
    </div>
    
    <div class="controls disabled" id="videoControls">
      <div class="transport-controls">
        <button id="playBtn">Play</button>
        <button id="pauseBtn">Pause</button>
        <div class="time-display">
          <span id="currentTime">00:00</span> / <span id="duration">00:00</span>
        </div>
      </div>
      
      <div class="seek-container">
        <input type="range" min="0" max="100" value="0" class="seek-bar" id="seekBar">
      </div>
    </div>
    
    <div class="file-controls">
      <button id="loadFileBtn">Load Video File</button>
    </div>

    <div class="debug-panel disabled" id="debugPanel">
      <h3>Debug Information</h3>

   
      <div class="debug-section">
        <h4>Audio</h4>
        <div class="debug-row">
          <span class="debug-label">Codec:</span>
          <span class="debug-value" id="debugAudioCodec">--</span>
        </div>
        <div class="debug-row">
          <span class="debug-label">Sample Rate:</span>
          <span class="debug-value" id="debugAudioSampleRate">--</span>
        </div>
        <div class="debug-row">
          <span class="debug-label">Channels:</span>
          <span class="debug-value" id="debugAudioChannels">--</span>
        </div>
        <div class="debug-row">
          <span class="debug-label">Start Time:</span>
          <span class="debug-value" id="debugAudioStartTime">--</span>
        </div>
        <div class="debug-row">
          <span class="debug-label">Pause Time:</span>
          <span class="debug-value" id="debugAudioPauseTime">--</span>
        </div>
      </div>

      <div class="debug-section">
        <h4>Video Renderer</h4>
        <div class="debug-row">
          <span class="debug-label">Codec:</span>
          <span class="debug-value" id="debugVideoCodec">--</span>
        </div>
        <div class="debug-row">
          <span class="debug-label">Resolution:</span>
          <span class="debug-value" id="debugVideoResolution">--</span>
        </div>
        <div class="debug-row">
          <span class="debug-label">Frame Rate:</span>
          <span class="debug-value" id="debugVideoFrameRate">--</span>
        </div>
        <div class="debug-row">
          <span class="debug-label">Render Buffer Size:</span>
          <span class="debug-value" id="debugVideoRenderBufferSize">--</span>
        </div>
        <div class="debug-row">
          <span class="debug-label">Decode Queue Size:</span>
          <span class="debug-value" id="debugVideoDecodeQueueSize">--</span>
        </div>
        <div class="debug-row">
          <span class="debug-label">Last Rendered Time:</span>
          <span class="debug-value" id="debugVideoLastRenderedTime">--</span>
        </div>
      </div>

      <div class="debug-section">
        <h4>Clock</h4>
        <div class="debug-row">
          <span class="debug-label">Is Playing:</span>
          <span class="debug-value" id="debugClockIsPlaying">--</span>
        </div>
        <div class="debug-row">
          <span class="debug-label">Current Time:</span>
          <span class="debug-value" id="debugClockCurrentTime">--</span>
        </div>
      </div>
    </div>
  </div>
  
  <script type="module" src="/demos/player/demo.ts"></script>
  
  <script>
    // This script assumes the demo.ts will expose a videoPlayer object with the necessary methods
    document.addEventListener('DOMContentLoaded', () => {
      const playBtn = document.getElementById('playBtn');
      const pauseBtn = document.getElementById('pauseBtn');
      const seekBar = document.getElementById('seekBar');
      const currentTimeEl = document.getElementById('currentTime');
      const durationEl = document.getElementById('duration');
      const videoControls = document.getElementById('videoControls');
      
      // Format time helper function (converts seconds to MM:SS format)
      function formatTime(seconds) {
        seconds = Math.floor(seconds);
        const minutes = Math.floor(seconds / 60);
        seconds = seconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }
      
      // Global variable that will be set by demo.ts when a video is loaded
      window.setupVideoControls = function(videoPlayer) {
        let isDraggingSeekBar = false;
        let videoDuration = 0;
        let debugUpdateInterval = null;

        // Enable controls
        videoControls.classList.remove('disabled');
        document.getElementById('debugPanel').classList.remove('disabled');
        
        // Play button
        playBtn.addEventListener('click', () => {

          console.log("Playing");
          videoPlayer.play();
        });
        
        // Pause button
        pauseBtn.addEventListener('click', () => {
          videoPlayer.pause();
        });
        
        // Seek bar input (while dragging)
        seekBar.addEventListener('input', () => {
          isDraggingSeekBar = true;
          const seekTime = (seekBar.value / 100) * videoDuration;
          currentTimeEl.textContent = formatTime(seekTime);
        });
        
        // Seek bar change (on release)
        seekBar.addEventListener('change', () => {
          const seekTime = (seekBar.value / 100) * videoDuration;
          videoPlayer.seek(seekTime);
          isDraggingSeekBar = false;
        });
        
        // Update duration if available
        if (videoPlayer.duration) {
          videoDuration = videoPlayer.duration;
          durationEl.textContent = formatTime(videoDuration);
        }
        
        // Listen for time updates
        videoPlayer.on('timeupdate', (time) => {
          if (!isDraggingSeekBar) {
            currentTimeEl.textContent = formatTime(time);
            if (videoDuration > 0) {
              seekBar.value = (time / videoDuration) * 100;
            }
          }
        });
        
        // Listen for duration change
        videoPlayer.on('durationchange', (duration) => {
          videoDuration = duration;
          durationEl.textContent = formatTime(duration);
        });
        
        // Update UI based on player state
        videoPlayer.on('play', () => {
          playBtn.disabled = true;
          pauseBtn.disabled = false;
          console.log('Current time:', videoPlayer.getCurrentTime());
        });

        videoPlayer.on('pause', () => {
          playBtn.disabled = false;
          pauseBtn.disabled = true;
          console.log('Paused at:', videoPlayer.getCurrentTime());
        });

        // Initial state
        pauseBtn.disabled = true;

        // Display initial state
        console.log('Player initialized at time:', videoPlayer.getCurrentTime());
        console.log('Video duration:', videoPlayer.duration);

        // Update debug info periodically
        async function updateDebugInfo() {
          try {
            const debugInfo = await videoPlayer.getDebugInfo();

            // Track Data
       //     document.getElementById('debugDuration').textContent = debugInfo.trackData.duration.toFixed(2) + 's';

            // Audio
            if (debugInfo.trackData.audio) {
              const audio = debugInfo.trackData.audio;
              document.getElementById('debugAudioCodec').textContent = audio.codec || '--';
              document.getElementById('debugAudioSampleRate').textContent = audio.sampleRate + ' Hz';
              document.getElementById('debugAudioChannels').textContent = audio.numberOfChannels;
              document.getElementById('debugAudioStartTime').textContent = audio.startTime.toFixed(2) + 's';
              document.getElementById('debugAudioPauseTime').textContent = audio.pauseTime.toFixed(2) + 's';
              // Note: loadedSegments = number of decoded audio segments (30s blocks containing EncodedAudioChunks)
            }

            // Video
            if (debugInfo.trackData.video) {
              const video = debugInfo.trackData.video;
              document.getElementById('debugVideoCodec').textContent = video.codec || '--';
              document.getElementById('debugVideoResolution').textContent = video.width && video.height ? `${video.width}x${video.height}` : '--';
              document.getElementById('debugVideoFrameRate').textContent = video.frameRate ? `${video.frameRate} fps` : '--';
              //document.getElementById('debugVideoCurrentChunk').textContent = video.currentChunkIndex ?? '--';
              //document.getElementById('debugVideoTotalRenderers').textContent = video.totalRenderers ?? '--';
            //  document.getElementById('debugVideoLoadedChunks').textContent = video.loadedChunks ?? '--';
          //    document.getElementById('debugVideoIsPreloading').textContent = video.isPreloading ? 'Yes' : 'No';

              if (video.activeRenderer) {
                document.getElementById('debugVideoRenderBufferSize').textContent = video.activeRenderer.renderBufferSize ?? '--';
                document.getElementById('debugVideoDecodeQueueSize').textContent = video.activeRenderer.decodeQueueSize ?? '--';
                document.getElementById('debugVideoLastRenderedTime').textContent =
                  video.activeRenderer.lastRenderedTime ? (video.activeRenderer.lastRenderedTime / 1000000).toFixed(2) + 's' : '--';
              } else {
                document.getElementById('debugVideoRenderBufferSize').textContent = '--';
                document.getElementById('debugVideoDecodeQueueSize').textContent = '--';
                document.getElementById('debugVideoLastRenderedTime').textContent = '--';
              }
            }

            // Clock
            if (debugInfo.clock) {
              document.getElementById('debugClockIsPlaying').textContent = debugInfo.clock.isPlaying ? 'Yes' : 'No';
              document.getElementById('debugClockCurrentTime').textContent = debugInfo.clock.currentTime.toFixed(2) + 's';
            }
          } catch (error) {
            console.error('Error updating debug info:', error);
          }
        }

        // Update debug info every 500ms
        debugUpdateInterval = setInterval(updateDebugInfo, 500);
        updateDebugInfo(); // Initial update
      };
    });
  </script>
</body>
</html>